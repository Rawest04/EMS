<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Los Santos Medical | Management System v2.0</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6; --primary-dark: #1e40af; --primary-light: #93c5fd;
            --sidebar: #0f172a; --sidebar-light: #1e293b;
            --bg: #f8fafc; --bg-dark: #f1f5f9;
            --card: #ffffff; 
            --accent: #06b6d4; --accent-light: #67e8f9;
            --success: #10b981; --success-light: #a7f3d0;
            --warning: #f59e0b; --warning-light: #fcd34d;
            --error: #ef4444; --error-light: #fca5a5;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: linear-gradient(135deg, var(--bg) 0%, var(--bg-dark) 100%); display: flex; height: 100vh; overflow: hidden; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-dark); }

        /* SIDEBAR */
        .sidebar { width: 280px; background: linear-gradient(180deg, var(--sidebar) 0%, var(--sidebar-light) 100%); color: white; padding: 30px 20px; display: flex; flex-direction: column; box-shadow: 4px 0 20px rgba(0,0,0,0.1); }
        .logo { display: flex; align-items: center; gap: 12px; font-size: 1.4rem; font-weight: 800; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 40px; animation: fadeInDown 0.6s ease; }
        
        .nav-item { 
            display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px; 
            cursor: pointer; color: #cbd5e1; font-weight: 600; margin-bottom: 8px; text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .nav-item::before { content: ''; position: absolute; left: -20px; width: 4px; height: 0; background: var(--accent); border-radius: 0 2px 2px 0; transition: height 0.3s ease; }
        .nav-item:hover { background: rgba(255,255,255,0.08); color: white; transform: translateX(4px); }
        .nav-item.active { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; box-shadow: 0 8px 16px rgba(37,99,235,0.25); }
        .nav-item.active::before { height: 24px; }

        .dropdown { height: 0; overflow: hidden; padding-left: 20px; transition: height 0.3s ease; }
        .dropdown.open { height: auto; margin-bottom: 20px; }
        .sub-link { display: block; padding: 10px 12px; color: #94a3b8; font-size: 0.9rem; cursor: pointer; border-radius: 8px; transition: all 0.2s ease; }
        .sub-link:hover { color: white; background: rgba(255,255,255,0.1); padding-left: 16px; }

        /* MAIN CONTENT */
        .main { flex: 1; padding: 40px; overflow-y: auto; }
        h1 { color: #0f172a; font-size: 2.2rem; margin-bottom: 20px; font-weight: 700; background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        h2 { color: #1e293b; font-size: 1.5rem; margin-bottom: 15px; }
        h3 { color: #334155; font-size: 1.1rem; margin-bottom: 12px; }
        h4 { color: #475569; font-size: 0.95rem; }
        p { color: #64748b; line-height: 1.6; }
        label { color: #334155; font-weight: 600; display: block; margin-bottom: 6px; }

        .glass-card { 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 16px; 
            padding: 30px; 
            border: 1px solid rgba(226, 232, 240, 0.5);
            box-shadow: 0 8px 32px rgba(0,0,0,0.06), 0 0 0 1px rgba(255,255,255,0.5) inset;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        .glass-card:hover { 
            box-shadow: 0 12px 40px rgba(0,0,0,0.08), 0 0 0 1px rgba(255,255,255,0.8) inset;
            transform: translateY(-2px);
        }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        input, select, textarea { 
            width: 100%; 
            padding: 12px 14px; 
            border-radius: 10px; 
            border: 2px solid #e2e8f0; 
            margin-top: 5px; 
            font-family: inherit;
            background: white;
            color: #0f172a;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1), 0 4px 12px rgba(59,130,246,0.2);
            transform: scale(1.01);
        }
        input:hover, select:hover, textarea:hover { border-color: var(--primary-light); }
        
        .badge { 
            padding: 6px 12px; 
            border-radius: 8px; 
            font-size: 0.75rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            display: inline-block;
            transition: all 0.2s ease;
        }
        .badge:hover { transform: scale(1.05); }
        .bg-verde { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; box-shadow: 0 4px 12px rgba(16,185,129,0.15); }
        .bg-giallo { background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%); color: #78350f; box-shadow: 0 4px 12px rgba(245,158,11,0.15); }
        .bg-rosso { background: linear-gradient(135deg, #fee2e2 0%, #fca5a5 100%); color: #7c2d12; box-shadow: 0 4px 12px rgba(239,68,68,0.15); }

        .btn { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; 
            border: none; 
            padding: 12px 22px; 
            border-radius: 10px; 
            font-weight: 700; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            width: fit-content; 
            margin-top: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(59,130,246,0.3);
            position: relative;
            overflow: hidden;
        }
        .btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(255,255,255,0.3); transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
        .btn:hover::before { width: 300px; height: 300px; }
        .btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59,130,246,0.4);
        }
        .btn:active { transform: translateY(0); }
        .btn-red { background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%); box-shadow: 0 4px 15px rgba(239,68,68,0.3); }
        .btn-red:hover { box-shadow: 0 8px 25px rgba(239,68,68,0.4); }
        .btn-green { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); box-shadow: 0 4px 15px rgba(16,185,129,0.3); }
        .btn-green:hover { box-shadow: 0 8px 25px rgba(16,185,129,0.4); }

        /* Users admin table styles */
        .users-table { width: 100%; border-collapse: collapse; }
        .users-table th { text-align: left; padding: 10px 12px; color: #475569; background: rgba(15,23,42,0.03); border-bottom: 1px solid #e6eefc; }
        .users-table td { padding: 10px 12px; border-bottom: 1px solid #f1f5fb; vertical-align: middle; }
        .user-avatar { width:36px; height:36px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; background:var(--primary); color:white; font-weight:700; margin-right:8px; }
        .user-roles { display:flex; gap:6px; flex-wrap:wrap; }
        .user-role-badge { padding:4px 8px; border-radius:8px; background:#f1f5ff; color:#1e40af; font-size:0.75rem; font-weight:700; }
        .user-action-btn { padding:8px 10px; border-radius:8px; cursor:pointer; border:none; font-weight:700; }
        .user-action-edit { background: linear-gradient(135deg,#fbbf24,#f59e0b); color:white; }
        .user-action-del { background: linear-gradient(135deg,#ef4444,#dc2626); color:white; }
        .users-list-scroll { max-height:220px; overflow:auto; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; padding: 14px 12px; color: #475569; border-bottom: 2px solid var(--primary); font-size: 0.75rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; background: rgba(59,130,246,0.05); }
        td { padding: 14px 12px; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; color: #334155; transition: all 0.2s ease; }
        tbody tr { transition: all 0.2s ease; }
        tbody tr:hover { background: rgba(59,130,246,0.05); }

        .page { display: none; }
        .page.active { display: block; animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .lock-container { text-align: center; padding: 50px; }
        .lock-container i { color: var(--primary); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .ref-box { 
            padding: 18px; 
            border-left: 4px solid var(--primary); 
            background: linear-gradient(135deg, rgba(59,130,246,0.05) 0%, rgba(6,182,212,0.05) 100%);
            border-radius: 10px; 
            margin-bottom: 15px; 
            position: relative;
            transition: all 0.3s ease;
            border: 1px solid rgba(59,130,246,0.1);
        }
        .ref-box:hover { 
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(59,130,246,0.1);
            transform: translateX(4px);
        }
        .del-ref { position: absolute; right: 15px; top: 15px; color: var(--error); cursor: pointer; transition: all 0.2s ease; }
        .del-ref:hover { transform: scale(1.2); color: #dc2626; }
        /* Posiziona il login/session in alto a destra */
        #userBox { position: fixed; top: 18px; right: 20px; z-index: 1100; display: flex; gap: 8px; align-items: center; color: #cbd5e1; font-weight: 600; }
        #userBox .btn { padding: 8px 12px; font-size: 0.9rem; }

        @media (max-width: 768px) {
            #userBox { top: 10px; right: 12px; }
        }
        
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-card { 
            background: linear-gradient(135deg, white 0%, rgba(59,130,246,0.05) 100%);
            padding: 24px; 
            border-radius: 14px; 
            border-left: 5px solid var(--primary);
            border: 1px solid rgba(59,130,246,0.1);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        }
        .stat-card:hover { 
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(59,130,246,0.12);
            border-color: var(--primary);
        }
        .stat-card h2 { color: var(--primary); font-size: 2rem; }

        /* MOBILE RESPONSIVE */
        .menu-toggle { 
            display: none; 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none; 
            color: white; 
            padding: 12px 16px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1.2rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(59,130,246,0.25);
        }
        .menu-toggle:hover { transform: scale(1.05); box-shadow: 0 6px 16px rgba(59,130,246,0.35); }

        @media (max-width: 1024px) {
            .sidebar { width: 250px; padding: 20px 15px; }
            .main { padding: 30px 20px; }
            .grid-2 { grid-template-columns: 1fr; }
            .stat-grid { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { 
                width: 100%; 
                height: auto; 
                padding: 15px; 
                flex-direction: row; 
                align-items: center;
                justify-content: space-between;
                position: relative;
                z-index: 1000;
                background: linear-gradient(90deg, var(--sidebar) 0%, var(--sidebar-light) 100%);
            }
            .logo { margin-bottom: 0; font-size: 1.1rem; animation: none; }
            .nav-menu { 
                display: none; 
                flex-direction: column; 
                position: absolute; 
                top: 100%; 
                left: 0; 
                right: 0; 
                background: linear-gradient(180deg, var(--sidebar) 0%, var(--sidebar-light) 100%);
                padding: 10px;
                gap: 0;
                border-top: 1px solid rgba(255,255,255,0.1);
                box-shadow: 0 8px 16px rgba(0,0,0,0.15);
            }
            .nav-menu.open { display: flex; animation: slideDown 0.3s ease; }
            @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
            .nav-item { margin-bottom: 5px; padding: 10px 12px; font-size: 0.9rem; }
            .nav-item::before { display: none; }
            .menu-toggle { display: block; }
            .main { 
                flex: 1; 
                padding: 20px; 
                overflow-y: auto; 
            }
            .glass-card { 
                padding: 20px; 
                margin-bottom: 20px; 
                border-radius: 15px;
            }
            h1 { font-size: 1.7rem; }
            h2 { font-size: 1.2rem; }
            h3 { font-size: 1rem; }
            input, select, textarea { 
                padding: 10px; 
                font-size: 16px; /* Previene zoom su iOS */
            }
            .btn { 
                padding: 10px 16px; 
                font-size: 0.9rem;
                width: 100%;
                justify-content: center;
            }
            table { font-size: 0.8rem; }
            th, td { padding: 8px; }
            .grid-2 { grid-template-columns: 1fr; }
            .stat-grid { grid-template-columns: 1fr; }
            .stat-card { padding: 15px; }
            #cercaRegistro, #cercaReferto { width: 100% !important; margin-top: 15px; }
            .ref-box { padding: 12px; }
            .del-ref { position: static; display: inline; margin-left: 10px; }
        }

        @media (max-width: 480px) {
            body { font-size: 14px; }
            .sidebar { flex-wrap: wrap; }
            .logo { order: 1; font-size: 1rem; }
            .menu-toggle { order: 2; }
            .nav-menu { order: 3; width: 100%; }
            .main { padding: 15px; }
            .glass-card { padding: 15px; margin-bottom: 15px; }
            h1 { font-size: 1.4rem; }
            h2 { font-size: 1rem; }
            h3 { font-size: 0.9rem; }
            input, select, textarea { padding: 8px; font-size: 16px; }
            .btn { padding: 8px 12px; font-size: 0.85rem; }
            table { font-size: 0.75rem; }
            th, td { padding: 6px; }
            .badge { padding: 4px 8px; font-size: 0.6rem; }
            .stat-card { padding: 12px; }
            .ref-box { padding: 10px; }
        }

        /* Migliore lettura su schermi piccoli */
        @media (max-width: 768px) {
            .dropdown { padding-left: 0; }
            .sub-link { padding: 8px 10px; font-size: 0.85rem; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo"><i data-lucide="hospital"></i> <span style="display: inline-block; margin-left: 8px;">Los Santos Medical</span></div>
        <div id="userBox"></div>
        <button class="menu-toggle" onclick="toggleMenu()"><i data-lucide="menu"></i></button>
        <div id="nav-menu" class="nav-menu">
            <div class="nav-item active" onclick="nav('pazienti'); closeMenu()"><i data-lucide="users"></i> Pazienti</div>
            <div class="nav-item" onclick="toggleDrop(); event.stopPropagation();"><i data-lucide="lock"></i> Area Staff <i data-lucide="chevron-down" style="margin-left:auto"></i></div>
            <div id="drop" class="dropdown">
                <div class="sub-link" onclick="nav('registro'); closeMenu()">Registro Visite</div>
                <div class="sub-link" onclick="nav('concorsi'); closeMenu()">Concorsi Interni</div>
                <div class="sub-link" onclick="nav('referti'); closeMenu()">Gestione Referti</div>
                <div class="sub-link" onclick="nav('admin'); closeMenu()" style="color:#ef4444; font-weight: 700;">Amministrazione <i data-lucide="shield-check" size="14"></i></div>
            </div>
            <div class="nav-item" onclick="location.reload()"><i data-lucide="log-out"></i> Reset Sistema</div>
        </div>
    </aside>

    <main class="main">
        <div class="container">

            <section id="pazienti" class="page active">
                <h1><i data-lucide="users" style="display:inline; margin-right:10px;"></i>Pazienti</h1>
                
                <!-- TAB NAVIGATION -->
                <div style="display:flex; gap:10px; margin-bottom:20px; border-bottom:2px solid #e2e8f0; padding-bottom:0;">
                    <button class="tab-btn active" onclick="switchTab('tab-accettazione')" style="padding:12px 20px; background:none; border:none; border-bottom:3px solid transparent; cursor:pointer; font-weight:600; color:#0f172a; transition:all 0.3s;" id="btn-accettazione">üìã Accettazione Pazienti</button>
                    <!-- Concorsi moved to staff area (internal courses) -->
                </div>
                
                <!-- TAB: ACCETTAZIONE -->
                <div id="tab-accettazione" class="tab-content">
                    <div class="glass-card">
                        <h2>Registrazione Nuovo Paziente</h2>
                        <form id="formPaziente" class="grid-2">
                            <div>
                                <label>Nome</label>
                                <input type="text" id="fnome" placeholder="Es. Mario" required>
                            </div>
                            <div>
                                <label>Cognome</label>
                                <input type="text" id="fcognome" placeholder="Es. Rossi" required>
                            </div>
                            <div>
                                <label>Reparto / Prestazione</label>
                                <select id="freparto" onchange="updatePrezzo()">
                                    <option value="Visita Generica" data-price="1000">Visita Generica ($1000)</option>
                                    <option value="Cardiologia" data-price="1200">Cardiologia ($1.200)</option>
                                    <option value="Chirurgia" data-price="10000">Chirurgia ($10.000)</option>
                                    <option value="Radiologia" data-price="2000">Radiologia ($2.000)</option>
                                    <option value="Visita Pda" data-price="25000">Certificato PDA ($25.000)</option>
                                    <option value="Emergenza" data-price="2500">Emergenza / Trauma ($2.500)</option>
                                </select>
                            </div>
                            <div>
                                <label>Urgenza (Triage)</label>
                                <select id="fpriorita">
                                    <option value="verde">Verde (Routine)</option>
                                    <option value="giallo">Giallo (Urgente)</option>
                                    <option value="rosso">Rosso (Codice Rosso)</option>
                                </select>
                            </div>
                            <div>
                                <label>Data e Orario</label>
                                <input type="datetime-local" id="fdata" required>
                            </div>
                            <div>
                                <label>Prezzo Prestazione</label>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <h2 id="displayPrezzo" style="color:var(--primary); margin-top:0; margin-bottom:0;">$0</h2>
                                </div>
                            </div>
                            <button type="submit" class="btn" style="grid-column:span 2; justify-content:center;"><i data-lucide="check-circle"></i> Registra e Genera Fattura</button>
                        </form>
                    </div>
                </div>
                
                <!-- I bandi/concorsi sono diventati corsi interni e sono visibili solo nell'Area Staff -->
            </section>

            <section id="concorsi" class="page">
                        <div id="lock-staff-3" class="glass-card lock-container">
                            <i data-lucide="briefcase" size="48"></i>
                            <h2>Concorsi Interni</h2>
                            <p style="color:#64748b;">Area riservata allo staff. Effettua il login con un account autorizzato.</p>
                            <button class="btn" style="margin: 20px auto" onclick="openLoginModal('concorsi')">Accedi all'Area Staff</button>
                        </div>
                        <div id="content-staff-3" style="display:none">
                    <div class="glass-card">
                        <h2>üè´ Corsi Interni (Staff)</h2>
                        <div id="boxBandiStaff"></div>
                    </div>

                    <div id="formCand" class="glass-card" style="display:none; margin-top:12px;">
                        <h3>üìù Modulo Iscrizione al Corso</h3>
                        <p style="color:#64748b; margin-bottom:8px;">Iscrizione per: <strong><span id="labelBando"></span></strong></p>
                        <form class="grid-2" onsubmit="event.preventDefault(); inviaCandidatura();">
                            <input type="text" id="cNome" placeholder="Nome e Cognome" required>
                            <input type="text" id="cMail" placeholder="Email / Discord" required>
                            <textarea id="cNote" placeholder="Motivazioni / Note" style="grid-column: span 2; height:120px; resize:vertical;" required></textarea>
                            <button type="submit" class="btn" style="grid-column:span 2; justify-content:center;"><i data-lucide="send"></i> Invia Iscrizione</button>
                        </form>
                    </div>
                </div>
            </section>

            <section id="registro" class="page">
                <div id="lock-staff-1" class="glass-card lock-container">
                    <i data-lucide="user-cog" size="48"></i>
                    <h2>Accesso Registro Visite</h2>
                    <p>Area riservata: effettua il login con il tuo account staff.</p>
                    <button class="btn" style="margin: 20px auto" onclick="openLoginModal('registro')">Accedi</button>
                </div>
                <div id="content-staff-1" style="display:none" class="glass-card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h1>Pazienti in Lista</h1>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="text" id="cercaRegistro" placeholder="Cerca nome o reparto..." onkeyup="renderRegistro()" style="width:300px;">
                            <button class="btn" onclick="nav('concorsi');"><i data-lucide="briefcase"></i> Corsi Interni</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Triage</th>
                                <th>Paziente</th>
                                <th>Reparto</th>
                                <th>Orario</th>
                                <th>Fattura</th>
                                <th>Stato</th>
                                <th>Azione</th>
                            </tr>
                        </thead>
                        <tbody id="tab-registro"></tbody>
                    </table>
                </div>
            </section>

            <section id="referti" class="page">
                <div id="lock-staff-2" class="glass-card lock-container">
                    <i data-lucide="file-key" size="48"></i>
                    <h2>Gestione Referti Riservata</h2>
                    <p>Area riservata: effettua il login con il tuo account staff.</p>
                    <button class="btn" style="margin: 20px auto" onclick="openLoginModal('referti')">Accedi</button>
                </div>
                <div id="content-staff-2" style="display:none">
                    <div class="glass-card">
                        <h3>Nuovo Referto Clinico</h3>
                        <div class="grid-2">
                            <select id="selPaziente"><option value="">Seleziona Paziente...</option></select>
                            <input type="text" id="refTitolo" placeholder="Tipo di Esame / Diagnosi">
                            <textarea id="refTesto" placeholder="Inserisci qui l'esito clinico completo e le cure prescritte..." style="grid-column: span 2; height: 100px;"></textarea>
                            <button class="btn" onclick="salvaReferto()">Salva nel Fascicolo</button>
                        </div>
                    </div>
                    <div class="glass-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3>Archivio Storico Referti</h3>
                            <input type="text" id="cercaReferto" placeholder="Cerca nel database..." onkeyup="renderReferti()" style="width:300px;">
                        </div>
                        <div id="boxReferti"></div>
                    </div>
                </div>
            </section>

            <section id="admin" class="page">
                <div id="lock-admin" class="glass-card lock-container"><i data-lucide="shield-check" size="48" color="red"></i><h2>Amministrazione Centrale</h2><p>Accesso riservato agli amministratori. Effettua il login.</p><button class="btn btn-red" style="margin:20px auto" onclick="openLoginModal('admin')">Accesso Riservato</button></div>
                <div id="content-admin" style="display:none">
                    
                    <div class="stat-grid">
                        <div class="stat-card"><h4>Pazienti Totali</h4><h2 id="statPaz">0</h2></div>
                        <div class="stat-card" style="border-left-color: var(--success);"><h4>Incasso Totale</h4><h2 id="statIncasso">$0</h2></div>
                        <div class="stat-card" style="border-left-color: var(--accent);"><h4>Referti Emessi</h4><h2 id="statRef">0</h2></div>
                    </div>

                    <div class="glass-card">
                        <h3>Gestione Personale e Stipendi</h3>
                        <div class="grid-2">
                            <input type="text" id="dNome" placeholder="Nome Dipendente">
                            <input type="text" id="dRuolo" placeholder="Grado (es. Chirurgo)">
                            <input type="number" id="dBase" placeholder="Stipendio Base">
                            <input type="number" id="dBonus" placeholder="Bonus/Premi">
                            <button class="btn" onclick="addDipendente()">Registra Dipendente</button>
                        </div>
                        <table><thead><tr><th>Nome</th><th>Ruolo</th><th>Totale Mese</th><th>Azioni</th></tr></thead><tbody id="tab-dipendenti"></tbody></table>
                    </div>

                    <div class="glass-card" id="usersAdminCard">
                        <h3>üë• Gestione Utenti</h3>
                        <p style="color:#64748b; margin-bottom:10px;">Crea, modifica o rimuovi account staff (client-side).</p>
                        <div style="display:flex; gap:16px; align-items:flex-start; margin-bottom:12px;">
                            <div style="flex:1;">
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                                    <input id="uUsername" placeholder="Username" style="padding:8px; border-radius:6px; border:1px solid #e2e8f0;">
                                    <input id="uName" placeholder="Nome visualizzato" style="padding:8px; border-radius:6px; border:1px solid #e2e8f0;">
                                    <input id="uPassword" placeholder="Password (nuova)" style="padding:8px; border-radius:6px; border:1px solid #e2e8f0;">
                                    <div style="display:flex; gap:8px; align-items:center;">
                                        <label style="font-weight:600; color:#475569;">Ruoli:</label>
                                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                            <label style="color:#64748b;"><input type="checkbox" id="role-admin"> Admin</label>
                                            <label style="color:#64748b;"><input type="checkbox" id="role-registro"> Registro</label>
                                            <label style="color:#64748b;"><input type="checkbox" id="role-referti"> Referti</label>
                                            <label style="color:#64748b;"><input type="checkbox" id="role-concorsi"> Concorsi</label>
                                        </div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px; margin-top:10px;">
                                    <button class="btn btn-green" onclick="saveUserFromForm()">Salva Utente</button>
                                    <button class="btn" onclick="clearUserForm()">Nuovo</button>
                                </div>
                            </div>
                            <div style="flex:1;">
                                <div style="max-height:220px; overflow:auto; border:1px solid #eef2ff; border-radius:8px; padding:8px; background:#fff;">
                                        <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
                                            <input id="usersSearch" placeholder="Cerca username/nome..." style="flex:1; padding:8px; border-radius:6px; border:1px solid #e2e8f0;" oninput="renderUsersAdmin()">
                                            <select id="usersSort" style="width:160px; padding:8px; border-radius:6px; border:1px solid #e2e8f0;" onchange="renderUsersAdmin()">
                                                <option value="username">Ordina: Username</option>
                                                <option value="name">Ordina: Nome</option>
                                                <option value="roles">Ordina: Ruoli</option>
                                            </select>
                                        </div>
                                        <input type="hidden" id="uOriginal">
                                        <table style="width:100%;">
                                            <thead><tr><th>Username</th><th>Nome</th><th>Ruoli</th><th></th></tr></thead>
                                            <tbody id="usersAdminList"></tbody>
                                        </table>
                                    </div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card">
                        <h3>üìã Candidature Ricevute</h3>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <p style="color:#64748b;">Elenco di tutte le candidature per i corsi interni (visibili solo allo staff)</p>
                            <button class="btn btn-green" onclick="esportaCandidature()"><i data-lucide="download"></i> Scarica Candidature</button>
                        </div>
                        <div id="boxCandidature"></div>
                    </div>

                    <div class="glass-card">
                        <h3>üîß Gestione Corsi Interni</h3>
                        <p style="color:#64748b; margin-bottom:12px;">Chiudi o riapri i corsi interni manualmente. Se non vedi i corsi nuovi, usa <strong>Reset</strong> per ripristinare il seed iniziale.</p>
                        <div style="display:flex; gap:8px; margin-bottom:12px;">
                            <button class="btn" onclick="showAddBandoForm()">Aggiungi Bando</button>
                            <button class="btn btn-red" onclick="resetBandiConfirm()">Reset Bandi</button>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
                            <input id="discordWebhook" placeholder="Discord Webhook URL" style="flex:1; padding:8px; border-radius:6px; border:1px solid #e2e8f0;">
                            <label style="display:flex; align-items:center; gap:6px; color:#64748b;"><input type="checkbox" id="discordNotify" style="width:18px; height:18px;"> Abilita invio su Discord</label>
                            <button class="btn btn-green" onclick="saveDiscordWebhook()">Salva Webhook</button>
                        </div>
                        <div id="formAddBando" style="display:none; margin-bottom:12px;">
                            <div style="display:flex; gap:8px; align-items:center;">
                                <input id="newTitle" placeholder="Titolo bando (es. Infermiere)" style="flex:1; padding:8px; border-radius:6px; border:1px solid #e2e8f0;">
                                <input id="newLimit" type="number" placeholder="Limite" style="width:90px; padding:8px; border-radius:6px; border:1px solid #e2e8f0;">
                                <input id="newPos" type="number" placeholder="Posizioni" style="width:110px; padding:8px; border-radius:6px; border:1px solid #e2e8f0;">
                                <button class="btn btn-green" onclick="addBando()">Salva</button>
                            </div>
                            <input id="newReq" placeholder="Requisiti (breve)" style="margin-top:8px; width:100%; padding:8px; border-radius:6px; border:1px solid #e2e8f0;">
                        </div>
                        <div id="boxBandiAdmin"></div>
                    </div>

                    <button class="btn btn-green" onclick="esportaDati()"><i data-lucide="download"></i> Scarica Backup Database (JSON)</button>
                </div>
            </section>

            </section>

        </div>
    </main>

    <!-- Login modal -->
    <div id="loginModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:9999;">
        <div style="width:420px; max-width:92%; margin:auto; background:white; border-radius:12px; padding:20px;">
            <h3 style="margin-top:0;">Accesso Staff</h3>
            <div style="display:flex; flex-direction:column; gap:8px;">
                <input id="loginUsername" placeholder="Username" style="padding:10px; border-radius:8px; border:1px solid #e2e8f0;">
                <input id="loginPassword" placeholder="Password" type="password" style="padding:10px; border-radius:8px; border:1px solid #e2e8f0;">
                <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
                    <button class="btn btn-red" onclick="closeLoginModal()">Annulla</button>
                    <button class="btn btn-green" onclick="doLogin()">Accedi</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        initBandi();
        // Users & session
        initUsers();
        loadSessionUI();
        
        // TAB SWITCHING
        function switchTab(tabName) {
            // Nascondi tutti i tab
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            // Togli stile attivo da tutti i bottoni
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.style.color = '#64748b';
                btn.style.borderBottomColor = 'transparent';
            });
            
            // Mostra il tab selezionato
            document.getElementById(tabName).style.display = 'block';
            
            // Aggiungi stile attivo al bottone cliccato
            if(tabName === 'tab-accettazione') {
                document.getElementById('btn-accettazione').style.color = '#0f172a';
                document.getElementById('btn-accettazione').style.borderBottomColor = 'var(--primary)';
            }
        }
        
        // MENU MOBILE TOGGLE
        function toggleMenu() { 
            document.getElementById('nav-menu').classList.toggle('open'); 
        }

        function closeMenu() { 
            document.getElementById('nav-menu').classList.remove('open');
        }

        // Chiude il menu se si clicca altrove
        document.addEventListener('click', (e) => {
            const sidebar = document.querySelector('.sidebar');
            const toggle = document.querySelector('.menu-toggle');
            if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
                closeMenu();
            }
        });
        
        // DATABASE HELPERS
        function getDB(key) { return JSON.parse(localStorage.getItem(key)) || []; }
        function saveDB(key, data) { localStorage.setItem(key, JSON.stringify(data)); }

        // Simple client-side users/session (not secure, localStorage only)
        function initUsers() {
            if(!localStorage.getItem('m_users')) {
                const users = [
                    { username: 'admin', password: 'admin123', roles: ['admin','concorsi','registro','referti'], name: 'Admin' },
                    { username: 'alice', password: 'staff123', roles: ['registro','concorsi'], name: 'Alice' },
                    { username: 'bob', password: 'staff123', roles: ['referti','concorsi'], name: 'Bob' }
                ];
                saveDB('m_users', users);
            }
        }

        // Toasts visuali
        function showToast(message, type = 'info', timeout = 3500) {
            let container = document.getElementById('toastContainer');
            if(!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.style.position = 'fixed';
                container.style.right = '20px';
                container.style.top = '20px';
                container.style.zIndex = 10000;
                container.style.display = 'flex';
                container.style.flexDirection = 'column';
                container.style.gap = '10px';
                document.body.appendChild(container);
            }
            const el = document.createElement('div');
            el.textContent = message;
            el.style.minWidth = '220px';
            el.style.padding = '12px 14px';
            el.style.borderRadius = '10px';
            el.style.boxShadow = '0 8px 20px rgba(2,6,23,0.2)';
            el.style.color = '#04263a';
            el.style.fontWeight = 700;
            el.style.background = '#eef2ff';
            if(type === 'success') el.style.background = 'linear-gradient(135deg,#d1fae5,#a7f3d0)';
            if(type === 'error') el.style.background = 'linear-gradient(135deg,#fee2e2,#fca5a5)';
            if(type === 'info') el.style.background = 'linear-gradient(135deg,#ebf8ff,#93c5fd)';
            container.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; setTimeout(()=>el.remove(),400); }, timeout);
        }

        function openLoginModal(target) {
            window.loginTarget = target || 'pazienti';
            const m = document.getElementById('loginModal');
            if(!m) return showToast('Login modal non disponibile','error');
            m.style.display = 'block';
            const u = document.getElementById('loginUsername'); if(u) u.focus();
        }

        function closeLoginModal() { const m = document.getElementById('loginModal'); if(m) m.style.display = 'none'; }

        function doLogin() {
            const u = document.getElementById('loginUsername').value.trim();
            const p = document.getElementById('loginPassword').value;
            const users = getDB('m_users');
            const user = users.find(x => x.username === u && x.password === p);
            if(!user) { showToast('Credenziali non valide','error'); return; }
            localStorage.setItem('session_user', user.username);
            localStorage.setItem('session_roles', JSON.stringify(user.roles));
            loadSessionUI();
            closeLoginModal();
            const target = window.loginTarget || 'pazienti';
            if(hasAccessForPage(target)) {
                nav(target);
                if(target === 'registro') { document.getElementById('content-staff-1').style.display = 'block'; renderRegistro(); }
                if(target === 'referti') { document.getElementById('content-staff-2').style.display = 'block'; renderReferti(); }
                if(target === 'concorsi') { document.getElementById('content-staff-3').style.display = 'block'; renderBandiStaff(); }
                if(target === 'admin') { document.getElementById('content-admin').style.display = 'block'; renderAdmin(); }
                showToast('Login effettuato','success');
            } else {
                showToast('Non hai i permessi per accedere a questa area.','error');
            }
        }

        function hasAccessForPage(page) {
            const roles = JSON.parse(localStorage.getItem('session_roles') || '[]');
            if(!roles || roles.length === 0) return false;
            if(roles.includes('admin')) return true;
            return roles.includes(page);
        }

        function loadSessionUI() {
            const user = localStorage.getItem('session_user') || '';
            const box = document.getElementById('userBox');
            if(!box) return;
            if(user) {
                box.innerHTML = `<span style="color:#93c5fd">${user}</span><button class="btn" style="margin-left:auto;padding:6px 10px;" onclick="logout()">Logout</button>`;
            } else {
                box.innerHTML = '<button class="btn" onclick="openLoginModal()"><i data-lucide="log-in"></i> Login</button>';
            }
            lucide.createIcons();
        }

        function logout() {
            localStorage.removeItem('session_user');
            localStorage.removeItem('session_roles');
            loadSessionUI();
            showToast('Sei uscito','info');
            nav('pazienti');
        }

        // NAVIGATION
        function nav(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'pazienti') switchTab('tab-accettazione');
            // staff areas: show lock or content based on roles
            const staffMap = {
                registro: { lock: 'lock-staff-1', content: 'content-staff-1' },
                referti: { lock: 'lock-staff-2', content: 'content-staff-2' },
                concorsi: { lock: 'lock-staff-3', content: 'content-staff-3' },
                admin: { lock: 'lock-admin', content: 'content-admin' }
            };
            Object.keys(staffMap).forEach(k => {
                const lk = document.getElementById(staffMap[k].lock);
                const ct = document.getElementById(staffMap[k].content);
                if(lk) lk.style.display = 'none';
                if(ct) ct.style.display = 'none';
            });
            if(['registro','referti','concorsi','admin'].includes(id)) {
                if(hasAccessForPage(id)) {
                    const ct = document.getElementById(staffMap[id].content);
                    if(ct) ct.style.display = 'block';
                    if(id === 'registro') renderRegistro();
                    if(id === 'referti') renderReferti();
                    if(id === 'concorsi') renderBandiStaff();
                    if(id === 'admin') renderAdmin();
                } else {
                    const lk = document.getElementById(staffMap[id].lock);
                    if(lk) lk.style.display = 'block';
                }
            } else {
                if(id === 'referti') aggiornaListaPazienti();
            }
        }

        function toggleDrop() { document.getElementById('drop').classList.toggle('open'); }

        // legacy unlock removed - role-based login enforced via `openLoginModal` and `hasAccessForPage`

        // FATTURAZIONE DINAMICA
        function updatePrezzo() {
            const select = document.getElementById('freparto');
            const prezzo = select.options[select.selectedIndex].getAttribute('data-price');
            document.getElementById('displayPrezzo').innerText = "$" + parseInt(prezzo).toLocaleString();
        }

        // REGISTRAZIONE PAZIENTE
        document.getElementById('formPaziente').addEventListener('submit', (e) => {
            e.preventDefault();
            let p = getDB('m_paz');
            const select = document.getElementById('freparto');
            const costo = select.options[select.selectedIndex].getAttribute('data-price');
            
            p.push({ 
                id: Date.now(), 
                n: document.getElementById('fnome').value, 
                c: document.getElementById('fcognome').value, 
                r: select.value, 
                prio: document.getElementById('fpriorita').value,
                d: document.getElementById('fdata').value,
                prezzo: parseInt(costo),
                stato: 'In Attesa'
            });
            
            saveDB('m_paz', p); 
            showToast('Paziente registrato e fattura generata','success'); 
            e.target.reset();
            updatePrezzo();
        });

        // RENDER REGISTRO STAFF
        function renderRegistro() {
            let p = getDB('m_paz');
            const query = document.getElementById('cercaRegistro').value.toLowerCase();
            const t = document.getElementById('tab-registro'); 
            t.innerHTML = "";

            // Ordina per urgenza (Rosso > Giallo > Verde)
            const prioVal = { rosso: 1, giallo: 2, verde: 3 };
            p.sort((a, b) => prioVal[a.prio] - prioVal[b.prio]);

            p.filter(i => (i.n + i.c + i.r).toLowerCase().includes(query)).forEach(i => {
                const badgeClass = i.prio === 'rosso' ? 'bg-rosso' : (i.prio === 'giallo' ? 'bg-giallo' : 'bg-verde');
                t.innerHTML += `
                    <tr>
                        <td><span class="badge ${badgeClass}">${i.prio}</span></td>
                        <td><strong>${i.c} ${i.n}</strong></td>
                        <td>${i.r}</td>
                        <td>${new Date(i.d).toLocaleString('it-IT').slice(0,-3)}</td>
                        <td><strong>$${i.prezzo.toLocaleString()}</strong></td>
                        <td>
                            <select onchange="updateStato(${i.id}, this.value)" style="padding:5px; font-size:0.8rem;">
                                <option ${i.stato === 'In Attesa' ? 'selected' : ''}>In Attesa</option>
                                <option ${i.stato === 'In Visita' ? 'selected' : ''}>In Visita</option>
                                <option ${i.stato === 'Concluso' ? 'selected' : ''}>Concluso</option>
                            </select>
                        </td>
                        <td><button onclick="delP(${i.id})" style="color:red; border:none; background:none; cursor:pointer;"><i data-lucide="trash-2" size="16"></i></button></td>
                    </tr>`;
            });
            lucide.createIcons();
        }

        function updateStato(id, s) {
            let p = getDB('m_paz');
            let idx = p.findIndex(x => x.id === id);
            p[idx].stato = s;
            saveDB('m_paz', p);
        }

        // REFERTI
        function aggiornaListaPazienti() {
            const s = document.getElementById('selPaziente'); s.innerHTML = '<option value="">Seleziona Paziente...</option>';
            getDB('m_paz').forEach(p => s.innerHTML += `<option value="${p.id}">${p.c} ${p.n}</option>`);
        }

        function salvaReferto() {
            const pId = document.getElementById('selPaziente').value;
            if(!pId) return showToast("Seleziona un paziente!","error");
            let r = getDB('m_ref');
            r.push({ id: Date.now(), pId: pId, titolo: document.getElementById('refTitolo').value, testo: document.getElementById('refTesto').value, data: new Date().toLocaleDateString() });
            saveDB('m_ref', r); renderReferti(); showToast("Referto salvato correttamente!","success");
        }

        function renderReferti() {
            const b = document.getElementById('boxReferti'); 
            const query = document.getElementById('cercaReferto').value.toLowerCase();
            b.innerHTML = "";
            const pazienti = getDB('m_paz');
            const referti = getDB('m_ref');

            referti.forEach(r => {
                const p = pazienti.find(x => x.id == r.pId);
                const nomePaz = p ? (p.c + " " + p.n).toLowerCase() : "ex paziente";
                if(nomePaz.includes(query) || r.titolo.toLowerCase().includes(query)) {
                    b.innerHTML += `
                        <div class="ref-box">
                            <i data-lucide="trash-2" class="del-ref" onclick="delRef(${r.id})"></i>
                            <small>${r.data}</small><br>
                            <strong>${p ? p.c + " " + p.n : 'Utente rimosso'} - ${r.titolo}</strong>
                            <p style="margin-top:10px; color:#475569;">${r.testo}</p>
                        </div>`;
                }
            });
            lucide.createIcons();
        }

        // ADMIN LOGIC
        function renderAdmin() {
            const p = getDB('m_paz');
            const r = getDB('m_ref');
            const d = getDB('m_dip');
            
            document.getElementById('statPaz').innerText = p.length;
            document.getElementById('statRef').innerText = r.length;
            const totale = p.reduce((acc, curr) => acc + curr.prezzo, 0);
            document.getElementById('statIncasso').innerText = "$" + totale.toLocaleString();

            const t1 = document.getElementById('tab-dipendenti'); t1.innerHTML = "";
            d.forEach(dip => t1.innerHTML += `<tr><td>${dip.n}</td><td>${dip.r}</td><td>$${dip.t.toLocaleString()}</td><td><button onclick="delD(${dip.id})">Rimuovi</button></td></tr>`);
            
            renderCandidature();
            renderBandiAdmin();
            renderUsersAdmin();
        }

        function renderCandidature() {
            const b = document.getElementById('boxCandidature');
            const candidature = getDB('m_cand');
            
            if(candidature.length === 0) {
                b.innerHTML = '<p style="color:#94a3b8; text-align:center; padding:20px;">Nessuna candidatura ricevuta ancora</p>';
                return;
            }
            
            b.innerHTML = '';
            candidature.forEach(c => {
                // Colori in base allo stato
                let statoStyle = '';
                let statoColor = '#000';
                let statoBg = '#fff';
                
                if(c.stato === 'In Sospeso') {
                    statoStyle = 'background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%); color: #78350f;';
                    statoColor = '#78350f';
                    statoBg = '#fcd34d';
                } else if(c.stato === 'Accettato') {
                    statoStyle = 'background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46;';
                    statoColor = '#065f46';
                    statoBg = '#a7f3d0';
                } else if(c.stato === 'Rifiutato') {
                    statoStyle = 'background: linear-gradient(135deg, #fee2e2 0%, #fca5a5 100%); color: #7c2d12;';
                    statoColor = '#7c2d12';
                    statoBg = '#fca5a5';
                }
                
                b.innerHTML += `
                    <div class="ref-box">
                        <div style="display:flex; justify-content:space-between; align-items:start; gap:10px;">
                            <div style="flex:1;">
                                <small style="color:#94a3b8;">${c.data}</small><br>
                                <strong style="color:#0f172a; font-size:1.05rem;">${c.nome}</strong> - <span style="color:#38bdf8; font-weight:600;">${c.bando}</span>
                                <p style="color:#64748b; margin-top:6px;"><strong>Contatto:</strong> ${c.contatto}</p>
                                <p style="color:#475569; margin-top:8px;">${c.note}</p>
                            </div>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <select onchange="updateStatoCandidatura(${c.id}, this.value)" style="padding:8px 12px; border-radius:8px; border:2px solid currentColor; ${statoStyle} cursor:pointer; font-size:0.85rem; font-weight:700; transition:all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <option value="In Sospeso" style="background:white; color:#000;">In Sospeso</option>
                                    <option value="Accettato" style="background:white; color:#000;">‚úì Accettato</option>
                                    <option value="Rifiutato" style="background:white; color:#000;">‚úó Rifiutato</option>
                                </select>
                                <button onclick="delCandidatura(${c.id})" style="background:none; border:none; color:#ef4444; cursor:pointer; padding:4px;" title="Elimina"><i data-lucide="trash-2" size="16"></i></button>
                            </div>
                        </div>
                    </div>`;
            });
            lucide.createIcons();
        }

        // Users admin functions
        function renderUsersAdmin() {
            const listEl = document.getElementById('usersAdminList');
            const users = getDB('m_users') || [];
            if(!listEl) return;
            listEl.innerHTML = '';
            const q = (document.getElementById('usersSearch') || {}).value || '';
            const ql = q.toLowerCase();
            const sort = (document.getElementById('usersSort') || {}).value || 'username';
            let filtered = users.filter(u => ((u.username || '') + ' ' + (u.name || '')).toLowerCase().includes(ql));
            if(sort === 'username') filtered.sort((a,b)=> (a.username||'').localeCompare(b.username||''));
            if(sort === 'name') filtered.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
            if(sort === 'roles') filtered.sort((a,b)=> (a.roles||[]).length - (b.roles||[]).length);

            filtered.forEach(u => {
                const roles = (u.roles || []);
                const initials = (u.name || u.username).split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
                const rolesHtml = roles.map(r => {
                    const icon = r === 'admin' ? 'shield-check' : (r === 'registro' ? 'book-open' : (r === 'referti' ? 'file-text' : 'briefcase'));
                    const label = r === 'admin' ? 'Admin' : (r === 'registro' ? 'Registro' : (r === 'referti' ? 'Referti' : 'Concorsi'));
                    return `<span class="user-role-badge" style="display:inline-flex;align-items:center;gap:8px;"><i data-lucide="${icon}" size="14"></i>${label}</span>`;
                }).join(' ');

                listEl.innerHTML += `
                    <tr>
                        <td style="padding:6px 8px; display:flex; align-items:center;">
                            <span class="user-avatar">${initials}</span>
                            <div style="display:flex; flex-direction:column;"><strong>${u.username}</strong><small style="color:#94a3b8">${u.name || ''}</small></div>
                        </td>
                        <td style="padding:6px 8px;">
                            <div class="user-roles">${rolesHtml}</div>
                        </td>
                        <td style="padding:6px 8px; text-align:right;">
                            <button class="user-action-btn user-action-edit" onclick="editUser('${u.username}')"><i data-lucide="edit-2" size="14"></i> Modifica</button>
                            <button class="user-action-btn user-action-del" onclick="deleteUser('${u.username}')" style="margin-left:8px"><i data-lucide="trash-2" size="14"></i> Elimina</button>
                        </td>
                    </tr>`;
            });
            lucide.createIcons();
        }

        function clearUserForm() {
            document.getElementById('uUsername').value = '';
            document.getElementById('uName').value = '';
            document.getElementById('uPassword').value = '';
            document.getElementById('role-admin').checked = false;
            document.getElementById('role-registro').checked = false;
            document.getElementById('role-referti').checked = false;
            document.getElementById('role-concorsi').checked = false;
            const orig = document.getElementById('uOriginal'); if(orig) orig.value = '';
        }

        function saveUserFromForm() {
            const username = document.getElementById('uUsername').value.trim();
            const original = (document.getElementById('uOriginal') || {}).value || '';
            const name = document.getElementById('uName').value.trim();
            const pass = document.getElementById('uPassword').value;
            const roles = [];
            if(document.getElementById('role-admin').checked) roles.push('admin');
            if(document.getElementById('role-registro').checked) roles.push('registro');
            if(document.getElementById('role-referti').checked) roles.push('referti');
            if(document.getElementById('role-concorsi').checked) roles.push('concorsi');
            if(!username) return showToast('Inserisci uno username','error');
            let users = getDB('m_users');
            if(original) {
                const origIdx = users.findIndex(u => u.username === original);
                if(origIdx === -1) return showToast('Utente originale non trovato','error');
                if(username !== original && users.some(u => u.username === username)) return showToast('Username gi√† in uso','error');
                if(pass && pass.length > 0 && pass.length < 6) return showToast('La password deve essere di almeno 6 caratteri','error');
                users[origIdx].username = username;
                users[origIdx].name = name;
                if(pass) users[origIdx].password = pass;
                users[origIdx].roles = roles;
                document.getElementById('uOriginal').value = '';
            } else {
                if(users.some(u => u.username === username)) return showToast('Username gi√† in uso','error');
                if(!pass || pass.length < 6) return showToast('Inserisci una password di almeno 6 caratteri','error');
                users.push({ username: username, password: pass, roles: roles, name: name });
            }
            saveDB('m_users', users);
            clearUserForm();
            renderUsersAdmin();
            showToast('Utenti aggiornati','success');
        }

        function editUser(username) {
            const users = getDB('m_users');
            const u = users.find(x => x.username === username);
            if(!u) return showToast('Utente non trovato','error');
            document.getElementById('uOriginal').value = u.username;
            document.getElementById('uUsername').value = u.username;
            document.getElementById('uName').value = u.name || '';
            document.getElementById('uPassword').value = '';
            document.getElementById('role-admin').checked = (u.roles || []).includes('admin');
            document.getElementById('role-registro').checked = (u.roles || []).includes('registro');
            document.getElementById('role-referti').checked = (u.roles || []).includes('referti');
            document.getElementById('role-concorsi').checked = (u.roles || []).includes('concorsi');
        }

        function deleteUser(username) {
            if(!confirm('Eliminare l\'utente "' + username + '"?')) return;
            const session = localStorage.getItem('session_user');
            if(session === username) { showToast('Non puoi eliminare l\'utente loggato.','error'); return; }
            let users = getDB('m_users').filter(u => u.username !== username);
            saveDB('m_users', users);
            renderUsersAdmin();
            showToast('Utente eliminato','success');
        }

        function updateStatoCandidatura(id, nuovoStato) {
            let candidature = getDB('m_cand');
            let idx = candidature.findIndex(x => x.id === id);
            if(idx !== -1) {
                candidature[idx].stato = nuovoStato;
                saveDB('m_cand', candidature);
                renderCandidature();
                loadDiscordSettings();
                renderBandiAdmin();
            }
        }

        function delCandidatura(id) {
            if(confirm("Eliminare questa candidatura?")) {
                let c = getDB('m_cand').filter(x => x.id !== id);
                saveDB('m_cand', c);
                renderCandidature();
            }
        }

        function esportaCandidature() {
            const candidature = getDB('m_cand');
            if(candidature.length === 0) { showToast("Nessuna candidatura da esportare","info"); return; }
            const blob = new Blob([JSON.stringify(candidature, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Candidature_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function addDipendente() {
            let d = getDB('m_dip');
            const base = parseFloat(document.getElementById('dBase').value || 0);
            const bonus = parseFloat(document.getElementById('dBonus').value || 0);
            d.push({ id: Date.now(), n: document.getElementById('dNome').value, r: document.getElementById('dRuolo').value, t: (base + bonus) });
            saveDB('m_dip', d); renderAdmin();
        }

        function esportaDati() {
            const data = { pazienti: getDB('m_paz'), referti: getDB('m_ref'), dipendenti: getDB('m_dip') };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `LSM_Database_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        // DELETE FUNCTIONS
        function delP(id) { if(confirm("Eliminare la prenotazione?")) { let p = getDB('m_paz').filter(x => x.id !== id); saveDB('m_paz', p); renderRegistro(); } }
        function delRef(id) { if(confirm("Eliminare il referto?")) { let r = getDB('m_ref').filter(x => x.id !== id); saveDB('m_ref', r); renderReferti(); } }
        function delD(id) { let d = getDB('m_dip').filter(x => x.id !== id); saveDB('m_dip', d); renderAdmin(); }

        // BANDI & CANDIDATURE
        let selectedBandoId = null;

        function initBandi() {
            let bandi = getDB('m_bandi');
            if(bandi.length === 0) {
                bandi = [
                    { id: 1, title: 'Chirurgo', positions: 2, limit: 2, requirements: '5+ anni esperienza, specializzazione', open: true },
                    { id: 2, title: 'Ginecologo', positions: 1, limit: 1, requirements: '3+ anni esperienza, iscrizione albo', open: true },
                    { id: 3, title: 'Infermiere', positions: 5, limit: 5, requirements: 'Diploma OSS/Laurea, turni', open: true },
                    { id: 4, title: 'Tecnico Radiologia', positions: 1, limit: 1, requirements: 'Patentino RX', open: true },
                    { id: 5, title: 'Psicologo', positions: 2, limit: 2, requirements: 'Laurea in Psicologia, esperienza clinica', open: true },
                    { id: 6, title: 'Tecnico Laboratorio', positions: 2, limit: 2, requirements: 'Esperienza in analisi di laboratorio', open: true },
                    { id: 7, title: 'Security', positions: 3, limit: 3, requirements: 'Patentino sicurezza, turni notturni', open: true }
                ];
                saveDB('m_bandi', bandi);
            }
        }

        function getBandoById(id) { return getDB('m_bandi').find(b => b.id == id); }

        function renderBandi() {
            initBandi();
            const container = document.getElementById('boxBandi');
            // Public listing removed: if container missing, do nothing (courses are staff-only)
            if(!container) return;
            const bandi = getDB('m_bandi');
            const candidature = getDB('m_cand');
            container.innerHTML = '';

            bandi.forEach(b => {
                const applicants = candidature.filter(c => (c.bandoId == b.id) || (c.bando == b.title)).length;
                const full = applicants >= b.limit;
                container.innerHTML += `
                    <div class="ref-box" style="display:flex; justify-content:space-between; align-items:center; gap:16px; margin-bottom:12px;">
                        <div style="flex:1">
                            <strong style="font-size:1.05rem; color:#0f172a;">${b.title}</strong>
                            <p style="margin:6px 0; color:#64748b;">${b.requirements}</p>
                            <small style="color:#94a3b8;">Posizioni: ${b.positions} ‚Ä¢ Limite candidature: ${b.limit} ‚Ä¢ Candidature attuali: ${applicants}</small>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
                            ${b.open && !full ? `<button class="btn" onclick="mostraCandidatura(${b.id})"><i data-lucide=\"send\"></i> Candidati</button>` : `<span class=\"badge ${b.open? 'bg-giallo':'bg-rosso'}\">${b.open? (full? 'Chiuso - Limite raggiunto' : 'Aperto') : 'Chiuso'}</span>`}
                            ${b.open? '<small style="color:#94a3b8;">Stato: Aperto</small>' : '<small style="color:#ef4444;">Stato: Chiuso</small>'}
                        </div>
                    </div>`;
            });
            lucide.createIcons();
        }

        // Render per lo staff (mostra i corsi interni nell'area staff)
        function renderBandiStaff() {
            initBandi();
            const container = document.getElementById('boxBandiStaff');
            if(!container) return;
            const bandi = getDB('m_bandi');
            const candidature = getDB('m_cand');
            container.innerHTML = '';
            bandi.forEach(b => {
                const applicants = candidature.filter(c => (c.bandoId == b.id) || (c.bando == b.title)).length;
                const full = applicants >= b.limit;
                container.innerHTML += `
                    <div class="ref-box" style="display:flex; justify-content:space-between; align-items:center; gap:16px; margin-bottom:12px;">
                        <div style="flex:1">
                            <strong style="font-size:1.05rem; color:#0f172a;">${b.title}</strong>
                            <p style="margin:6px 0; color:#64748b;">${b.requirements}</p>
                            <small style="color:#94a3b8;">Posizioni: ${b.positions} ‚Ä¢ Limite iscrizioni: ${b.limit} ‚Ä¢ Iscritti: ${applicants}</small>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
                            ${b.open && !full ? `<button class="btn" onclick="mostraCandidatura(${b.id})"><i data-lucide=\"send\"></i> Iscriviti</button>` : `<span class=\"badge ${b.open? 'bg-giallo':'bg-rosso'}\">${b.open? (full? 'Chiuso - Posti esauriti' : 'Aperto') : 'Chiuso'}</span>`}
                            ${b.open? '<small style="color:#94a3b8;">Stato: Aperto</small>' : '<small style="color:#ef4444;">Stato: Chiuso</small>'}
                        </div>
                    </div>`;
            });
            lucide.createIcons();
        }

        

        function mostraCandidatura(bandoId) { 
            const b = getBandoById(bandoId);
            if(!b || !b.open) { showToast('Corso chiuso o non trovato.','error'); return; }
            // Access to candidature form is reserved to staff/internal only
            const formEl = document.getElementById('formCand');
            if(!formEl) { showToast('I corsi interni sono visibili solo allo staff. Accedi all\'Area Staff.','error'); return; }
            const candidature = getDB('m_cand');
            const applicants = candidature.filter(c => (c.bandoId == b.id) || (c.bando == b.title)).length;
            if(applicants >= b.limit) {
                // chiudi automaticamente
                toggleBando(b.id, false);
                renderBandi();
                return showToast('Il bando ha raggiunto il limite di personale e ora √® chiuso.','info');
            }
            selectedBandoId = b.id;
            document.getElementById('formCand').style.display = 'block';
            document.getElementById('labelBando').innerText = b.title; 
        }

        function inviaCandidatura() {
            const nomeEl = document.getElementById('cNome');
            if(!nomeEl) { showToast('Modulo candidature non disponibile (corsi interni).','error'); return; }
            const nome = nomeEl.value.trim();
            const contatto = document.getElementById('cMail').value.trim();
            const note = document.getElementById('cNote').value.trim();
            const bando = getBandoById(selectedBandoId);

            if (!nome || !contatto || !note) { showToast('Per favore compila tutti i campi!','error'); return; }
            if(!bando || !bando.open) { showToast('Errore: bando non disponibile.','error'); return; }

            // verifica limite
            const candidature = getDB('m_cand');
            const applicants = candidature.filter(c => (c.bandoId == bando.id) || (c.bando == bando.title)).length;
            if(applicants >= bando.limit) { toggleBando(bando.id, false); renderBandi(); showToast('Mi dispiace, il bando ha gi√† raggiunto il limite di candidature.','info'); return; }

            candidature.push({
                id: Date.now(),
                bandoId: bando.id,
                bando: bando.title,
                nome: nome,
                contatto: contatto,
                note: note,
                data: new Date().toLocaleDateString('it-IT'),
                stato: 'In Sospeso'
            });
            saveDB('m_cand', candidature);

            // se raggiunge limite, chiudi
            const newApplicants = candidature.filter(c => (c.bandoId == bando.id) || (c.bando == bando.title)).length;
            if(newApplicants >= bando.limit) toggleBando(bando.id, false);

            showToast('Candidatura inviata con successo!','success');

            // Pulisci il form
            document.getElementById('formCand').style.display = 'none';
            document.getElementById('cNome').value = '';
            document.getElementById('cMail').value = '';
            document.getElementById('cNote').value = '';
            selectedBandoId = null;
            renderBandi();
        }

        function toggleBando(id, open) {
            let bandi = getDB('m_bandi');
            let idx = bandi.findIndex(b => b.id == id);
            if(idx === -1) return;
            bandi[idx].open = !!open;
            saveDB('m_bandi', bandi);
            renderBandi();
            renderBandiAdmin();
            // se il bando viene riaperto, invia notifica su Discord
            if(bandi[idx].open) {
                sendDiscordNotification(`Bando riaperto: **${bandi[idx].title}**\nPosizioni: ${bandi[idx].positions} ‚Ä¢ Limite candidature: ${bandi[idx].limit}`);
            }
        }

        function renderBandiAdmin() {
            const container = document.getElementById('boxBandiAdmin');
            if(!container) return;
            const bandi = getDB('m_bandi');
            container.innerHTML = '';
            bandi.forEach(b => {
                container.innerHTML += `
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px; border-bottom:1px solid #eef2ff;">
                        <div style="flex:1;">
                            <strong>${b.title}</strong><br>
                            <small style="color:#64748b;">Limite: <input id=\"limit-${b.id}\" type=\"number\" value=\"${b.limit}\" style=\"width:70px; margin-left:6px; padding:4px; border-radius:6px; border:1px solid #e2e8f0;\"> ‚Ä¢ Posizioni: <input id=\"pos-${b.id}\" type=\"number\" value=\"${b.positions}\" style=\"width:70px; margin-left:6px; padding:4px; border-radius:6px; border:1px solid #e2e8f0;\"></small>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn" onclick="toggleBando(${b.id}, ${b.open ? 'false' : 'true'})">${b.open ? 'Chiudi Bando' : 'Riapri Bando'}</button>
                            <button class="btn btn-green" onclick="saveBandoSettings(${b.id})">Salva</button>
                        </div>
                    </div>`;
            });
        }

        function saveBandoSettings(id) {
            const limitEl = document.getElementById('limit-' + id);
            const posEl = document.getElementById('pos-' + id);
            if(!limitEl || !posEl) return;
            const newLimit = parseInt(limitEl.value) || 0;
            const newPos = parseInt(posEl.value) || 0;
            let bandi = getDB('m_bandi');
            const idx = bandi.findIndex(b => b.id == id);
            if(idx === -1) { showToast('Bando non trovato','error'); return; }
            bandi[idx].limit = newLimit;
            bandi[idx].positions = newPos;
            saveDB('m_bandi', bandi);
            renderBandiAdmin();
            renderBandi();
            showToast('Impostazioni bando aggiornate','success');
        }

        // Admin: Aggiungi bando e reset
        function showAddBandoForm() {
            const f = document.getElementById('formAddBando');
            f.style.display = (f.style.display === 'block') ? 'none' : 'block';
        }

        function addBando() {
            const title = document.getElementById('newTitle').value.trim();
            const limit = parseInt(document.getElementById('newLimit').value) || 0;
            const pos = parseInt(document.getElementById('newPos').value) || 0;
            const req = document.getElementById('newReq').value.trim();
            if(!title) return showToast('Inserisci un titolo per il bando','error');
            const bandi = getDB('m_bandi');
            const id = bandi.length ? (Math.max(...bandi.map(b => b.id)) + 1) : 1;
            bandi.push({ id: id, title: title, positions: pos, limit: limit, requirements: req, open: true });
            saveDB('m_bandi', bandi);
            document.getElementById('newTitle').value = '';
            document.getElementById('newLimit').value = '';
            document.getElementById('newPos').value = '';
            document.getElementById('newReq').value = '';
            document.getElementById('formAddBando').style.display = 'none';
            renderBandi();
            renderBandiAdmin();
            // Notifica su Discord se abilitato
            const newBando = { id: id, title: title, positions: pos, limit: limit, requirements: req };
            sendDiscordNotification(`Nuovo bando pubblicato: **${newBando.title}**\nRequisiti: ${newBando.requirements || 'N/A'}\nPosizioni: ${newBando.positions} ‚Ä¢ Limite candidature: ${newBando.limit}`);
            showToast('Bando aggiunto con successo','success');
        }

        function resetBandiConfirm() {
            if(confirm('Sei sicuro di voler resettare i bandi al seed iniziale? Tutte le modifiche locali andranno perse.')) {
                resetBandi();
            }
        }

        function resetBandi() {
            const bandi = [
                { id: 1, title: 'Chirurgo', positions: 2, limit: 2, requirements: '5+ anni esperienza, specializzazione', open: true },
                { id: 2, title: 'Ginecologo', positions: 1, limit: 1, requirements: '3+ anni esperienza, iscrizione albo', open: true },
                { id: 3, title: 'Infermiere', positions: 5, limit: 5, requirements: 'Diploma OSS/Laurea, turni', open: true },
                { id: 4, title: 'Tecnico Radiologia', positions: 1, limit: 1, requirements: 'Patentino RX', open: true },
                { id: 5, title: 'Psicologo', positions: 2, limit: 2, requirements: 'Laurea in Psicologia, esperienza clinica', open: true },
                { id: 6, title: 'Tecnico Laboratorio', positions: 2, limit: 2, requirements: 'Esperienza in analisi di laboratorio', open: true },
                { id: 7, title: 'Security', positions: 3, limit: 3, requirements: 'Patentino sicurezza, turni notturni', open: true }
            ];
            saveDB('m_bandi', bandi);
            renderBandi();
            renderBandiAdmin();
            // Notifica sul canale Discord se abilitato
            const titles = bandi.map(b => b.title).join(', ');
            sendDiscordNotification(`Bandi ripristinati: ${titles}`);
            showToast('Bandi ripristinati al set iniziale','success');
        }

        // Discord integration
        function saveDiscordWebhook() {
            const url = document.getElementById('discordWebhook').value.trim();
            const enabled = document.getElementById('discordNotify').checked;
            if(url && enabled) {
                try { new URL(url); } catch(e) { return showToast('Webhook URL non valido','error'); }
            }
            localStorage.setItem('discord_webhook', url);
            localStorage.setItem('discord_notify', enabled ? '1' : '0');
            showToast('Impostazioni Discord salvate','success');
        }

        function loadDiscordSettings() {
            // Seed default webhook if not present (provided by user)
            const DEFAULT_DISCORD_WEBHOOK = 'https://discord.com/api/webhooks/1467317916751102066/EyS3DQ1w9MyperwVIUZeqTIBz4yi642GenLUbzX__uj9eJZ4jLcQ5sK0iCUai1GMybYR';
            if(!localStorage.getItem('discord_webhook')) {
                localStorage.setItem('discord_webhook', DEFAULT_DISCORD_WEBHOOK);
            }
            if(!localStorage.getItem('discord_notify')) {
                localStorage.setItem('discord_notify', '1');
            }
            const url = localStorage.getItem('discord_webhook') || '';
            const enabled = localStorage.getItem('discord_notify') === '1';
            const el = document.getElementById('discordWebhook');
            const cb = document.getElementById('discordNotify');
            if(el) el.value = url;
            if(cb) cb.checked = enabled;
        }

        async function sendDiscordNotification(message) {
            try {
                const enabled = localStorage.getItem('discord_notify') === '1';
                const webhook = localStorage.getItem('discord_webhook') || '';
                if(!enabled || !webhook) return;
                // Discord webhook expects JSON with content
                await fetch(webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: message })
                });
            } catch (err) {
                console.warn('Errore invio Discord:', err);
            }
        }
    </script>
</body>
</html>